<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Management - FreshMart POS</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{font-family:'Inter',sans-serif}
input:focus,select:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,0.1)}
</style>
</head>
<body class="bg-slate-100 min-h-screen">

<!-- Header -->
<div class="bg-white border-b border-slate-200">
<div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
<div>
<h1 class="text-slate-800 font-semibold">Stock Management</h1>
<p class="text-xs text-slate-400">View and manage stock across all locations</p>
</div>
<div class="flex items-center gap-2">
<button onclick="exportData()" class="px-3 py-2 text-sm text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium flex items-center gap-2">
<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
Export
</button>
<a href="#" class="px-4 py-2 text-sm bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-lg font-medium flex items-center gap-2">
<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
Adjust Stock
</a>
</div>
</div>
</div>

<main class="max-w-7xl mx-auto px-6 py-5 space-y-4">

<!-- Stats Cards -->
<div class="grid grid-cols-2 md:grid-cols-5 gap-3">
<div class="bg-white rounded-xl shadow-sm border border-slate-200/80 p-4">
<p class="text-[10px] text-slate-400 uppercase tracking-wider font-medium">Total Products</p>
<p class="text-2xl font-bold text-slate-800 mt-1" id="statTotal">0</p>
</div>
<div class="bg-white rounded-xl shadow-sm border border-slate-200/80 p-4">
<p class="text-[10px] text-slate-400 uppercase tracking-wider font-medium">Total Stock</p>
<p class="text-2xl font-bold text-emerald-600 mt-1" id="statStock">0</p>
</div>
<div class="bg-white rounded-xl shadow-sm border border-slate-200/80 p-4">
<p class="text-[10px] text-slate-400 uppercase tracking-wider font-medium">In Stock</p>
<p class="text-2xl font-bold text-blue-600 mt-1" id="statInStock">0</p>
</div>
<div class="bg-white rounded-xl shadow-sm border border-slate-200/80 p-4">
<p class="text-[10px] text-slate-400 uppercase tracking-wider font-medium">Low Stock</p>
<p class="text-2xl font-bold text-amber-500 mt-1" id="statLow">0</p>
</div>
<div class="bg-white rounded-xl shadow-sm border border-slate-200/80 p-4">
<p class="text-[10px] text-slate-400 uppercase tracking-wider font-medium">Out of Stock</p>
<p class="text-2xl font-bold text-red-500 mt-1" id="statOut">0</p>
</div>
</div>

<!-- Filters -->
<div class="bg-white rounded-xl shadow-sm border border-slate-200/80 p-4">
<div class="flex flex-col lg:flex-row gap-3">
<!-- Search -->
<div class="flex-1 relative">
<svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
<input type="text" id="search" placeholder="Search by name, SKU, barcode..." class="w-full pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm" oninput="filterTable()">
</div>

<!-- Filter Row -->
<div class="flex flex-wrap gap-2">
<!-- Category -->
<select id="filterCategory" class="px-3 py-2 border border-slate-200 rounded-lg text-sm text-slate-600" onchange="filterTable()">
<option value="">All Categories</option>
<option value="fruits">üçé Fruits</option>
<option value="vegetables">ü•¨ Vegetables</option>
<option value="dairy">ü•õ Dairy</option>
<option value="bakery">üçû Bakery</option>
<option value="beverages">ü•§ Beverages</option>
<option value="snacks">üçø Snacks</option>
<option value="meat">üçó Meat</option>
<option value="grains">üçö Grains</option>
</select>

<!-- View Type -->
<select id="filterViewType" class="px-3 py-2 border border-slate-200 rounded-lg text-sm text-slate-600" onchange="updateLocationFilter()">
<option value="all">All Locations</option>
<option value="warehouse">Warehouses Only</option>
<option value="branch">Branches Only</option>
</select>

<!-- Specific Location -->
<select id="filterLocation" class="px-3 py-2 border border-slate-200 rounded-lg text-sm text-slate-600" onchange="filterTable()">
<option value="">All</option>
</select>

<!-- Stock Status -->
<select id="filterStatus" class="px-3 py-2 border border-slate-200 rounded-lg text-sm text-slate-600" onchange="filterTable()">
<option value="">All Status</option>
<option value="instock">In Stock</option>
<option value="low">Low Stock</option>
<option value="out">Out of Stock</option>
</select>

<!-- Sort -->
<select id="filterSort" class="px-3 py-2 border border-slate-200 rounded-lg text-sm text-slate-600" onchange="filterTable()">
<option value="name">Name A-Z</option>
<option value="name-desc">Name Z-A</option>
<option value="stock-high">Stock High-Low</option>
<option value="stock-low">Stock Low-High</option>
<option value="sku">SKU</option>
</select>

<!-- Reset -->
<button onclick="resetFilters()" class="px-3 py-2 text-sm text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg font-medium">Reset</button>
</div>
</div>
</div>

<!-- Stock Table -->
<div class="bg-white rounded-xl shadow-sm border border-slate-200/80 overflow-hidden">
<table class="w-full">
<thead class="bg-slate-50 border-b border-slate-200">
<tr class="text-[10px] text-slate-500 uppercase tracking-wider">
<th class="px-4 py-3 text-left font-semibold">Product</th>
<th class="px-4 py-3 text-left font-semibold">Category</th>
<th class="px-4 py-3 text-right font-semibold">Cost</th>
<th class="px-4 py-3 text-right font-semibold">Sale</th>
<th class="px-4 py-3 text-center font-semibold">Total Stock</th>
<th class="px-4 py-3 text-center font-semibold">Warehouses</th>
<th class="px-4 py-3 text-center font-semibold">Branches</th>
<th class="px-4 py-3 text-center font-semibold">Status</th>
<th class="px-4 py-3 text-right font-semibold">Actions</th>
</tr>
</thead>
<tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
</table>

<!-- Empty State -->
<div id="emptyState" class="p-12 text-center" style="display:none">
<div class="w-16 h-16 mx-auto bg-slate-100 rounded-full flex items-center justify-center mb-4">
<svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
</div>
<p class="text-slate-500 font-medium">No products found</p>
<p class="text-sm text-slate-400 mt-1">Try adjusting your filters</p>
</div>

<!-- Pagination -->
<div class="px-4 py-3 border-t border-slate-200 flex items-center justify-between bg-slate-50/50">
<p class="text-xs text-slate-500">Showing <span id="showCount" class="font-medium text-slate-700">0</span> of <span id="totalCount" class="font-medium text-slate-700">0</span> products</p>
<div class="flex items-center gap-1">
<button onclick="changePage(-1)" class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-white rounded-lg" id="prevBtn">
<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
</button>
<span class="px-2 py-1 text-xs text-slate-600" id="pageInfo">1 / 1</span>
<button onclick="changePage(1)" class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-white rounded-lg" id="nextBtn">
<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
</button>
</div>
</div>
</div>

</main>

<!-- Toast -->
<div id="toast" class="fixed top-4 right-4 z-50 px-4 py-3 bg-slate-800 text-white text-sm rounded-lg shadow-lg flex items-center gap-2" style="display:none">
<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
<span id="toastMsg">Success</span>
</div>

<!-- Stock Detail Modal -->
<div id="stockModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display:none">
<div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeStockModal()"></div>
<div class="relative bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden">
<div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
<div class="flex items-center gap-3">
<span class="text-2xl" id="modalEmoji">üì¶</span>
<div>
<h3 class="text-lg font-semibold text-slate-800" id="modalName">Product Name</h3>
<p class="text-xs text-slate-400" id="modalSku">SKU000</p>
</div>
</div>
<button onclick="closeStockModal()" class="p-1 hover:bg-slate-100 rounded-lg">
<svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
</button>
</div>

<div class="p-5 overflow-y-auto max-h-[60vh]">
<!-- Summary -->
<div class="grid grid-cols-2 gap-3 mb-4">
<div class="bg-slate-50 rounded-lg p-3">
<p class="text-[10px] text-slate-500 uppercase font-semibold">Cost Price</p>
<p class="text-xl font-bold text-slate-700" id="modalCost">‡ß≥0</p>
</div>
<div class="bg-emerald-50 rounded-lg p-3">
<p class="text-[10px] text-emerald-600 uppercase font-semibold">Sale Price</p>
<p class="text-xl font-bold text-emerald-700" id="modalSale">‡ß≥0</p>
</div>
</div>
<div class="grid grid-cols-3 gap-3 mb-5">
<div class="bg-slate-100 rounded-lg p-3 text-center">
<p class="text-[10px] text-slate-600 uppercase font-semibold">Total Stock</p>
<p class="text-xl font-bold text-slate-800" id="modalTotal">0</p>
<p class="text-[10px] text-slate-500" id="modalTotalBulk"></p>
</div>
<div class="bg-blue-50 rounded-lg p-3 text-center">
<p class="text-[10px] text-blue-600 uppercase font-semibold">Warehouses</p>
<p class="text-xl font-bold text-blue-700" id="modalWarehouse">0</p>
<p class="text-[10px] text-blue-500" id="modalWarehouseBulk"></p>
</div>
<div class="bg-purple-50 rounded-lg p-3 text-center">
<p class="text-[10px] text-purple-600 uppercase font-semibold">Branches</p>
<p class="text-xl font-bold text-purple-700" id="modalBranch">0</p>
<p class="text-[10px] text-purple-500" id="modalBranchBulk"></p>
</div>
</div>

<!-- Warehouse Stock -->
<div class="mb-5">
<h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
<svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
Warehouse Stock
</h4>
<div class="space-y-2" id="modalWarehouseList"></div>
</div>

<!-- Branch Stock -->
<div>
<h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
<svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
Branch Stock
</h4>
<div class="space-y-2" id="modalBranchList"></div>
</div>
</div>

<div class="px-5 py-3 border-t border-slate-200 bg-slate-50 flex justify-between">
<button onclick="printStock()" class="px-4 py-2 text-sm text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 rounded-lg font-medium flex items-center gap-2">
<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z"/></svg>
Print
</button>
<button onclick="closeStockModal()" class="px-4 py-2 text-sm bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium">Close</button>
</div>
</div>
</div>

<script>
const warehouses=[
{id:'warehouse-main',name:'Main Warehouse'},
{id:'warehouse-north',name:'North Warehouse'},
{id:'warehouse-south',name:'South Warehouse'}
];

const branches=[
{id:'main',name:'Main Branch'},
{id:'dhanmondi',name:'Dhanmondi Branch'},
{id:'uttara',name:'Uttara Branch'},
{id:'mirpur',name:'Mirpur Branch'}
];

const products=[
{id:1,sku:'SKU001',name:'Fresh Apple',emoji:'üçé',category:'fruits',lowAlert:50,costPrice:40,salePrice:55,unit:'pcs',bulkUnit:'box',bulkQty:24,stock:{'warehouse-main':500,'warehouse-north':300,'warehouse-south':200,'main':150,'dhanmondi':80,'uttara':45,'mirpur':60}},
{id:2,sku:'SKU002',name:'Banana Bunch',emoji:'üçå',category:'fruits',lowAlert:60,costPrice:30,salePrice:45,unit:'pcs',bulkUnit:'crate',bulkQty:50,stock:{'warehouse-main':600,'warehouse-north':400,'warehouse-south':350,'main':200,'dhanmondi':120,'uttara':90,'mirpur':75}},
{id:3,sku:'SKU003',name:'Orange Fresh',emoji:'üçä',category:'fruits',lowAlert:40,costPrice:50,salePrice:70,unit:'pcs',bulkUnit:'box',bulkQty:30,stock:{'warehouse-main':450,'warehouse-north':280,'warehouse-south':190,'main':100,'dhanmondi':65,'uttara':40,'mirpur':55}},
{id:4,sku:'SKU004',name:'Milk 1L Pack',emoji:'ü•õ',category:'dairy',lowAlert:100,costPrice:65,salePrice:85,unit:'pcs',bulkUnit:'carton',bulkQty:12,stock:{'warehouse-main':800,'warehouse-north':500,'warehouse-south':400,'main':300,'dhanmondi':150,'uttara':100,'mirpur':120}},
{id:5,sku:'SKU005',name:'Whole Wheat Bread',emoji:'üçû',category:'bakery',lowAlert:30,costPrice:45,salePrice:60,unit:'pcs',bulkUnit:'carton',bulkQty:20,stock:{'warehouse-main':300,'warehouse-north':180,'warehouse-south':120,'main':80,'dhanmondi':45,'uttara':30,'mirpur':40}},
{id:6,sku:'SKU006',name:'Eggs (12 pcs)',emoji:'ü•ö',category:'dairy',lowAlert:80,costPrice:120,salePrice:150,unit:'pack',bulkUnit:'case',bulkQty:10,stock:{'warehouse-main':700,'warehouse-north':450,'warehouse-south':380,'main':250,'dhanmondi':130,'uttara':85,'mirpur':95}},
{id:7,sku:'SKU007',name:'Chicken Breast',emoji:'üçó',category:'meat',lowAlert:50,costPrice:280,salePrice:350,unit:'kg',bulkUnit:'box',bulkQty:15,stock:{'warehouse-main':400,'warehouse-north':250,'warehouse-south':180,'main':120,'dhanmondi':70,'uttara':50,'mirpur':60}},
{id:8,sku:'SKU008',name:'Rice 5kg Bag',emoji:'üçö',category:'grains',lowAlert:60,costPrice:380,salePrice:450,unit:'bag',bulkUnit:'pallet',bulkQty:25,stock:{'warehouse-main':550,'warehouse-north':320,'warehouse-south':280,'main':180,'dhanmondi':90,'uttara':65,'mirpur':80}},
{id:9,sku:'SKU009',name:'Coca Cola 500ml',emoji:'ü•§',category:'beverages',lowAlert:100,costPrice:25,salePrice:35,unit:'pcs',bulkUnit:'carton',bulkQty:24,stock:{'warehouse-main':1000,'warehouse-north':650,'warehouse-south':500,'main':400,'dhanmondi':200,'uttara':150,'mirpur':180}},
{id:10,sku:'SKU010',name:'Potato Chips',emoji:'üçø',category:'snacks',lowAlert:70,costPrice:35,salePrice:50,unit:'pcs',bulkUnit:'box',bulkQty:48,stock:{'warehouse-main':650,'warehouse-north':400,'warehouse-south':320,'main':220,'dhanmondi':110,'uttara':80,'mirpur':95}},
{id:11,sku:'SKU011',name:'Carrot Fresh',emoji:'ü•ï',category:'vegetables',lowAlert:40,costPrice:60,salePrice:80,unit:'kg',bulkUnit:'sack',bulkQty:20,stock:{'warehouse-main':380,'warehouse-north':220,'warehouse-south':150,'main':90,'dhanmondi':55,'uttara':35,'mirpur':45}},
{id:12,sku:'SKU012',name:'Broccoli',emoji:'ü•¶',category:'vegetables',lowAlert:30,costPrice:90,salePrice:120,unit:'pcs',bulkUnit:'crate',bulkQty:15,stock:{'warehouse-main':0,'warehouse-north':0,'warehouse-south':0,'main':0,'dhanmondi':0,'uttara':0,'mirpur':0}},
{id:13,sku:'SKU013',name:'Greek Yogurt',emoji:'ü•õ',category:'dairy',lowAlert:50,costPrice:75,salePrice:95,unit:'pcs',bulkUnit:'carton',bulkQty:12,stock:{'warehouse-main':200,'warehouse-north':100,'warehouse-south':80,'main':40,'dhanmondi':20,'uttara':15,'mirpur':18}},
{id:14,sku:'SKU014',name:'Croissant',emoji:'ü•ê',category:'bakery',lowAlert:25,costPrice:40,salePrice:55,unit:'pcs',bulkUnit:'tray',bulkQty:10,stock:{'warehouse-main':150,'warehouse-north':80,'warehouse-south':60,'main':35,'dhanmondi':18,'uttara':12,'mirpur':15}},
];

let currentPage=1;
const perPage=10;

function formatBulk(qty,bulkUnit,bulkQty,unit){
if(!bulkQty||bulkQty<=0)return `${qty} ${unit}`;
const bulks=Math.floor(qty/bulkQty);
const remainder=qty%bulkQty;
if(bulks===0)return `${remainder} ${unit}`;
if(remainder===0)return `${bulks} ${bulkUnit}`;
return `${bulks} ${bulkUnit} ${remainder} ${unit}`;
}

function formatPrice(n){return '‡ß≥'+n.toLocaleString()}

function showToast(msg){
const t=document.getElementById('toast');
document.getElementById('toastMsg').textContent=msg;
t.style.display='flex';
setTimeout(()=>t.style.display='none',3000);
}

function getTotalStock(p,filter){
let total=0;
const viewType=filter||document.getElementById('filterViewType').value;
const location=document.getElementById('filterLocation').value;

if(location){
return p.stock[location]||0;
}

if(viewType==='all'||viewType==='warehouse'){
warehouses.forEach(w=>{total+=(p.stock[w.id]||0)});
}
if(viewType==='all'||viewType==='branch'){
branches.forEach(b=>{total+=(p.stock[b.id]||0)});
}
return total;
}

function getWarehouseStock(p){
let total=0;
warehouses.forEach(w=>{total+=(p.stock[w.id]||0)});
return total;
}

function getBranchStock(p){
let total=0;
branches.forEach(b=>{total+=(p.stock[b.id]||0)});
return total;
}

function getStatus(p){
const total=getTotalStock(p,'all');
if(total===0)return 'out';
if(total<=p.lowAlert)return 'low';
return 'instock';
}

function updateStats(){
let totalProducts=products.length;
let totalStock=0;
let inStock=0,lowStock=0,outStock=0;

products.forEach(p=>{
const stock=getTotalStock(p,'all');
totalStock+=stock;
const status=getStatus(p);
if(status==='instock')inStock++;
else if(status==='low')lowStock++;
else outStock++;
});

document.getElementById('statTotal').textContent=totalProducts;
document.getElementById('statStock').textContent=totalStock.toLocaleString();
document.getElementById('statInStock').textContent=inStock;
document.getElementById('statLow').textContent=lowStock;
document.getElementById('statOut').textContent=outStock;
}

function updateLocationFilter(){
const viewType=document.getElementById('filterViewType').value;
const locationSelect=document.getElementById('filterLocation');
let options='<option value="">All</option>';

if(viewType==='all'){
options+='<optgroup label="Warehouses">';
warehouses.forEach(w=>{options+=`<option value="${w.id}">${w.name}</option>`});
options+='</optgroup><optgroup label="Branches">';
branches.forEach(b=>{options+=`<option value="${b.id}">${b.name}</option>`});
options+='</optgroup>';
}else if(viewType==='warehouse'){
warehouses.forEach(w=>{options+=`<option value="${w.id}">${w.name}</option>`});
}else{
branches.forEach(b=>{options+=`<option value="${b.id}">${b.name}</option>`});
}

locationSelect.innerHTML=options;
filterTable();
}

function getFiltered(){
const search=document.getElementById('search').value.toLowerCase();
const category=document.getElementById('filterCategory').value;
const status=document.getElementById('filterStatus').value;
const sort=document.getElementById('filterSort').value;

let list=products.filter(p=>{
const matchSearch=p.name.toLowerCase().includes(search)||p.sku.toLowerCase().includes(search);
const matchCategory=!category||p.category===category;
const matchStatus=!status||getStatus(p)===status;
return matchSearch&&matchCategory&&matchStatus;
});

if(sort==='name')list.sort((a,b)=>a.name.localeCompare(b.name));
else if(sort==='name-desc')list.sort((a,b)=>b.name.localeCompare(a.name));
else if(sort==='stock-high')list.sort((a,b)=>getTotalStock(b)-getTotalStock(a));
else if(sort==='stock-low')list.sort((a,b)=>getTotalStock(a)-getTotalStock(b));
else if(sort==='sku')list.sort((a,b)=>a.sku.localeCompare(b.sku));

return list;
}

function filterTable(){
currentPage=1;
renderTable();
}

function renderTable(){
const filtered=getFiltered();
const totalPages=Math.ceil(filtered.length/perPage)||1;
if(currentPage>totalPages)currentPage=totalPages;
const start=(currentPage-1)*perPage;
const paged=filtered.slice(start,start+perPage);

document.getElementById('totalCount').textContent=filtered.length;
document.getElementById('showCount').textContent=paged.length;
document.getElementById('pageInfo').textContent=currentPage+' / '+totalPages;

if(!filtered.length){
document.getElementById('tableBody').innerHTML='';
document.getElementById('emptyState').style.display='block';
return;
}
document.getElementById('emptyState').style.display='none';

const viewType=document.getElementById('filterViewType').value;
const location=document.getElementById('filterLocation').value;

document.getElementById('tableBody').innerHTML=paged.map(p=>{
const total=getTotalStock(p);
const warehouseTotal=getWarehouseStock(p);
const branchTotal=getBranchStock(p);
const status=getStatus(p);
const statusClass=status==='instock'?'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-600/20':status==='low'?'bg-amber-50 text-amber-700 ring-1 ring-amber-600/20':'bg-red-50 text-red-600 ring-1 ring-red-500/20';
const statusText=status==='instock'?'In Stock':status==='low'?'Low Stock':'Out of Stock';
const categoryLabel=p.category.charAt(0).toUpperCase()+p.category.slice(1);
const bulkDisplay=formatBulk(total,p.bulkUnit,p.bulkQty,p.unit);

const rowClass=paged.indexOf(p)%2===0?'bg-white':'bg-slate-50/50';
return`<tr class="${rowClass} hover:bg-emerald-50/50 text-sm">
<td class="px-4 py-3">
<div class="flex items-center gap-3">
<span class="text-xl">${p.emoji}</span>
<div>
<span class="font-medium text-slate-800">${p.name}</span>
<p class="text-[10px] font-mono text-slate-400">${p.sku}</p>
</div>
</div>
</td>
<td class="px-4 py-3 text-slate-600">${categoryLabel}</td>
<td class="px-4 py-3 text-right">
<span class="text-sm text-slate-600">${formatPrice(p.costPrice)}</span>
</td>
<td class="px-4 py-3 text-right">
<span class="text-sm font-semibold text-emerald-600">${formatPrice(p.salePrice)}</span>
</td>
<td class="px-4 py-3 text-center">
<div>
<span class="font-bold ${total>0?'text-slate-800':'text-red-500'}">${total.toLocaleString()}</span>
<p class="text-[10px] text-slate-400 mt-0.5">${bulkDisplay}</p>
</div>
</td>
<td class="px-4 py-3 text-center">
<span class="text-sm text-blue-600 font-medium">${warehouseTotal.toLocaleString()}</span>
</td>
<td class="px-4 py-3 text-center">
<span class="text-sm text-purple-600 font-medium">${branchTotal.toLocaleString()}</span>
</td>
<td class="px-4 py-3 text-center">
<span class="inline-flex px-2 py-0.5 text-[10px] font-semibold rounded-full ${statusClass}">${statusText}</span>
</td>
<td class="px-4 py-3">
<div class="flex justify-end gap-1">
<button onclick="viewStock(${p.id})" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg" title="View Details">
<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
</button>
<button onclick="adjustStock(${p.id})" class="p-1.5 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg" title="Adjust">
<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
</button>
</div>
</td>
</tr>`;
}).join('');
}

function changePage(dir){
const filtered=getFiltered();
const totalPages=Math.ceil(filtered.length/perPage)||1;
const newPage=currentPage+dir;
if(newPage>=1&&newPage<=totalPages){
currentPage=newPage;
renderTable();
}
}

function resetFilters(){
document.getElementById('search').value='';
document.getElementById('filterCategory').value='';
document.getElementById('filterViewType').value='all';
document.getElementById('filterStatus').value='';
document.getElementById('filterSort').value='name';
updateLocationFilter();
showToast('Filters reset');
}

function viewStock(id){
const p=products.find(pr=>pr.id===id);
if(!p)return;

document.getElementById('modalEmoji').textContent=p.emoji;
document.getElementById('modalName').textContent=p.name;
document.getElementById('modalSku').textContent=p.sku+' ‚Ä¢ '+p.bulkQty+' '+p.unit+'/'+p.bulkUnit;

const warehouseTotal=getWarehouseStock(p);
const branchTotal=getBranchStock(p);
const total=warehouseTotal+branchTotal;

document.getElementById('modalCost').textContent=formatPrice(p.costPrice);
document.getElementById('modalSale').textContent=formatPrice(p.salePrice);
document.getElementById('modalTotal').textContent=total.toLocaleString();
document.getElementById('modalTotalBulk').textContent=formatBulk(total,p.bulkUnit,p.bulkQty,p.unit);
document.getElementById('modalWarehouse').textContent=warehouseTotal.toLocaleString();
document.getElementById('modalWarehouseBulk').textContent=formatBulk(warehouseTotal,p.bulkUnit,p.bulkQty,p.unit);
document.getElementById('modalBranch').textContent=branchTotal.toLocaleString();
document.getElementById('modalBranchBulk').textContent=formatBulk(branchTotal,p.bulkUnit,p.bulkQty,p.unit);

// Warehouse list
document.getElementById('modalWarehouseList').innerHTML=warehouses.map(w=>{
const stock=p.stock[w.id]||0;
const percent=warehouseTotal>0?Math.round((stock/warehouseTotal)*100):0;
const bulkStr=formatBulk(stock,p.bulkUnit,p.bulkQty,p.unit);
return`<div class="flex items-center justify-between p-3 bg-blue-50/50 rounded-lg">
<div class="flex-1">
<p class="text-sm font-medium text-slate-700">${w.name}</p>
<div class="w-full bg-blue-100 rounded-full h-1.5 mt-1">
<div class="bg-blue-500 h-1.5 rounded-full" style="width:${percent}%"></div>
</div>
</div>
<div class="text-right ml-4">
<p class="text-lg font-bold text-blue-600">${stock.toLocaleString()}</p>
<p class="text-[10px] text-slate-500">${bulkStr}</p>
</div>
</div>`;
}).join('');

// Branch list
document.getElementById('modalBranchList').innerHTML=branches.map(b=>{
const stock=p.stock[b.id]||0;
const percent=branchTotal>0?Math.round((stock/branchTotal)*100):0;
const bulkStr=formatBulk(stock,p.bulkUnit,p.bulkQty,p.unit);
return`<div class="flex items-center justify-between p-3 bg-purple-50/50 rounded-lg">
<div class="flex-1">
<p class="text-sm font-medium text-slate-700">${b.name}</p>
<div class="w-full bg-purple-100 rounded-full h-1.5 mt-1">
<div class="bg-purple-500 h-1.5 rounded-full" style="width:${percent}%"></div>
</div>
</div>
<div class="text-right ml-4">
<p class="text-lg font-bold text-purple-600">${stock.toLocaleString()}</p>
<p class="text-[10px] text-slate-500">${bulkStr}</p>
</div>
</div>`;
}).join('');

document.getElementById('stockModal').style.display='flex';
}

function closeStockModal(){
document.getElementById('stockModal').style.display='none';
}

function adjustStock(id){
showToast('Opening stock adjustment...');
}

function printStock(){
showToast('Printing stock details...');
}

function exportData(){
showToast('Exporting stock data...');
}

// Init
updateLocationFilter();
updateStats();
renderTable();
</script>
</body>
</html>
