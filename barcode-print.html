<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Barcode Labels - FreshMart POS</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.6/JsBarcode.all.min.js"></script>
<style>
*{font-family:'Inter',sans-serif;box-sizing:border-box}
input:focus,select:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,0.1)}

@media print{
  .no-print{display:none!important}
  body{margin:0;padding:0;background:#fff!important}
  #printArea{display:block!important;background:#fff!important}
  @page{margin:0;padding:0}
  
  .print-roll{background:#fff}
  .print-roll .bcode{
    page-break-after:always;
    page-break-inside:avoid;
    margin:0;
    padding:0!important;
    border:none!important;
    background:#fff;
  }
  .print-roll .bcode:last-child{page-break-after:auto}
  
  .print-a4{display:flex;flex-wrap:wrap;gap:2mm;padding:5mm;align-content:flex-start;background:#fff}
  .print-a4 .bcode{page-break-inside:avoid;margin:0;border:1px solid #ccc;background:#fff}
}

.bcode{
  background:#fff;
  text-align:center;
  font-family:Arial,sans-serif;
  display:inline-flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  border:1px solid #e2e8f0;
  gap:1px;
}
.bcode .shop-name{font-weight:700;text-transform:uppercase;line-height:1.1}
.bcode .product-name{line-height:1.1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:98%}
.bcode .price{font-weight:700;line-height:1.1;margin-top:4px}
.bcode svg{max-width:98%;height:auto;flex-shrink:0}
</style>
</head>
<body class="bg-slate-100 min-h-screen">

<header class="bg-white border-b border-slate-200 sticky top-0 z-40 no-print">
<div class="max-w-7xl mx-auto px-4 py-2.5 flex items-center justify-between">
<div class="flex items-center gap-3">
<button onclick="window.history.back()" class="w-9 h-9 rounded-lg bg-slate-100 hover:bg-slate-200 flex items-center justify-center">
<svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
</button>
<div>
<h1 class="text-lg font-bold text-slate-800">Barcode Labels</h1>
<p class="text-xs text-slate-400">Generate & print product barcodes</p>
</div>
</div>
<div class="flex items-center gap-2">
<button onclick="clearAll()" class="px-3 py-2 text-sm text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium">Clear All</button>
<button onclick="printLabels()" class="px-4 py-2 text-sm bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-lg font-semibold shadow-sm hover:shadow flex items-center gap-2">
<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>Print
</button>
</div>
</div>
</header>

<main class="max-w-7xl mx-auto px-4 py-5 no-print">
<div class="grid grid-cols-12 gap-5">

<div class="col-span-12 lg:col-span-5 space-y-4">

<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
<h3 class="text-sm font-semibold text-slate-800 mb-3">Select Source</h3>
<div class="flex gap-2 mb-3">
<button onclick="setSource('search')" id="srcSearch" class="flex-1 py-2 text-xs font-semibold rounded-lg bg-emerald-100 text-emerald-700 border-2 border-emerald-500">Search</button>
<button onclick="setSource('purchase')" id="srcPurchase" class="flex-1 py-2 text-xs font-semibold rounded-lg bg-slate-100 text-slate-600 border-2 border-transparent">Purchase</button>
<button onclick="setSource('category')" id="srcCategory" class="flex-1 py-2 text-xs font-semibold rounded-lg bg-slate-100 text-slate-600 border-2 border-transparent">Category</button>
</div>

<div id="searchPanel">
<div class="relative">
<svg class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
<input type="text" id="productSearch" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm" placeholder="Search name, SKU, barcode..." oninput="searchProducts()">
</div>
<div id="searchResults" class="mt-2 max-h-48 overflow-y-auto space-y-1"></div>
</div>

<div id="purchasePanel" class="hidden">
<select id="purchaseInvoice" onchange="loadPurchaseItems()" class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm mb-2">
<option value="">Select Purchase Invoice</option>
<option value="PUR-001">PUR-001 - 20 Dec 2024</option>
<option value="PUR-002">PUR-002 - 18 Dec 2024</option>
</select>
<div id="purchaseItems" class="max-h-48 overflow-y-auto space-y-1"></div>
</div>

<div id="categoryPanel" class="hidden">
<select id="categorySelect" onchange="loadCategoryProducts()" class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm mb-2">
<option value="">Select Category</option>
<option value="fruits">üçé Fruits</option>
<option value="dairy">ü•õ Dairy</option>
<option value="bakery">üçû Bakery</option>
<option value="meat">ü•© Meat</option>
<option value="vegetables">ü•ï Vegetables</option>
</select>
<div id="categoryProducts" class="max-h-48 overflow-y-auto space-y-1"></div>
</div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
<h3 class="text-sm font-semibold text-slate-800 mb-3">Label & Printer Settings</h3>

<div class="grid grid-cols-2 gap-3 mb-3">
<div>
<label class="text-[10px] text-slate-500 uppercase font-semibold mb-1 block">Printer Type</label>
<div class="flex gap-1">
<button onclick="setPrinter('roll')" id="prnRoll" class="flex-1 py-2 px-2 text-xs font-semibold rounded-lg bg-emerald-100 text-emerald-700 border-2 border-emerald-500">üñ®Ô∏è Roll</button>
<button onclick="setPrinter('a4')" id="prnA4" class="flex-1 py-2 px-2 text-xs font-semibold rounded-lg bg-slate-100 text-slate-600 border-2 border-transparent">üìÑ A4</button>
</div>
</div>
<div>
<label class="text-[10px] text-slate-500 uppercase font-semibold mb-1 block">Label Size</label>
<select id="labelSize" onchange="renderPreview()" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
<option value="38x25">38 √ó 25 mm</option>
<option value="50x25">50 √ó 25 mm</option>
<option value="50x30">50 √ó 30 mm</option>
<option value="50x38">50 √ó 38 mm</option>
<option value="60x40">60 √ó 40 mm</option>
</select>
</div>
</div>

<div class="grid grid-cols-2 gap-2 mt-3">
<label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
<input type="checkbox" id="showShop" checked onchange="renderPreview()" class="w-4 h-4 rounded border-slate-300 text-emerald-600">
<span class="text-xs text-slate-700">Shop Name</span>
</label>
<label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
<input type="checkbox" id="showName" checked onchange="renderPreview()" class="w-4 h-4 rounded border-slate-300 text-emerald-600">
<span class="text-xs text-slate-700">Product Name</span>
</label>
<label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
<input type="checkbox" id="showPrice" checked onchange="renderPreview()" class="w-4 h-4 rounded border-slate-300 text-emerald-600">
<span class="text-xs text-slate-700">Price</span>
</label>
<label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
<input type="checkbox" id="showVat" onchange="renderPreview()" class="w-4 h-4 rounded border-slate-300 text-emerald-600">
<span class="text-xs text-slate-700">VAT++</span>
</label>
</div>
<div class="mt-3 grid grid-cols-2 gap-3">
<div>
<label class="text-[10px] text-slate-500 uppercase font-semibold mb-1 block">Shop Name</label>
<input type="text" id="shopName" value="FRESHMART" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold" oninput="renderPreview()">
</div>
<div>
<label class="text-[10px] text-slate-500 uppercase font-semibold mb-1 block">Font Size</label>
<div class="flex items-center gap-2">
<button onclick="changeFont(-1)" class="w-8 h-9 rounded-lg bg-slate-200 hover:bg-slate-300 text-sm font-bold">‚àí</button>
<span id="fontSizeVal" class="text-sm font-semibold text-slate-700 w-8 text-center">9</span>
<button onclick="changeFont(1)" class="w-8 h-9 rounded-lg bg-slate-200 hover:bg-slate-300 text-sm font-bold">+</button>
</div>
</div>
</div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
<div class="flex items-center justify-between mb-3">
<h3 class="text-sm font-semibold text-slate-800">Print Queue <span id="queueCount" class="px-2 py-0.5 bg-amber-100 text-amber-700 text-[10px] font-bold rounded-full ml-1">0</span></h3>
<span class="text-xs text-slate-400" id="totalLabels">0 labels</span>
</div>
<div id="printQueue" class="max-h-48 overflow-y-auto space-y-2"></div>
<div id="emptyQueue" class="text-center py-6 text-slate-400 text-sm">No products selected</div>
</div>
</div>

<div class="col-span-12 lg:col-span-7">
<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sticky top-20">
<div class="flex items-center justify-between mb-4">
<h3 class="text-sm font-semibold text-slate-800">Preview <span id="sizeInfo" class="text-xs text-slate-400 font-normal ml-2"></span></h3>
<div class="flex items-center gap-2">
<button onclick="zoomOut()" class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/></svg></button>
<span id="zoomLevel" class="text-xs text-slate-500 w-10 text-center">100%</span>
<button onclick="zoomIn()" class="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"/></svg></button>
</div>
</div>
<div class="bg-white rounded-lg p-4 min-h-[400px] overflow-auto flex justify-center border border-slate-200">
<div id="previewWrap" style="transform-origin:top center">
<div id="previewArea" class="flex flex-wrap gap-2 justify-center"></div>
</div>
</div>
</div>
</div>

</div>
</main>

<div id="printArea" style="display:none;background:#fff"></div>

<div id="toast" class="fixed top-16 right-4 z-50 px-4 py-3 bg-slate-800 text-white text-sm rounded-lg shadow-lg items-center gap-2 no-print" style="display:none">
<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
<span id="toastMsg">Added</span>
</div>

<script>
let printQueue=[];
let zoom=100;
let printerType='roll';
let fontSize=9;

// Load settings from localStorage
function loadSettings(){
  try{
    const saved=localStorage.getItem('barcodeSettings');
    if(saved){
      const s=JSON.parse(saved);
      printerType=s.printerType||'roll';
      fontSize=s.fontSize||9;
      zoom=s.zoom||100;
      document.getElementById('labelSize').value=s.labelSize||'38x25';
      document.getElementById('showShop').checked=s.showShop!==false;
      document.getElementById('showName').checked=s.showName!==false;
      document.getElementById('showPrice').checked=s.showPrice!==false;
      document.getElementById('showVat').checked=s.showVat||false;
      document.getElementById('shopName').value=s.shopName||'FRESHMART';
      document.getElementById('fontSizeVal').textContent=fontSize;
      document.getElementById('zoomLevel').textContent=zoom+'%';
      setPrinter(printerType);
    }
  }catch(e){}
}

// Save settings to localStorage
function saveSettings(){
  try{
    const s={
      printerType,
      fontSize,
      zoom,
      labelSize:document.getElementById('labelSize').value,
      showShop:document.getElementById('showShop').checked,
      showName:document.getElementById('showName').checked,
      showPrice:document.getElementById('showPrice').checked,
      showVat:document.getElementById('showVat').checked,
      shopName:document.getElementById('shopName').value
    };
    localStorage.setItem('barcodeSettings',JSON.stringify(s));
  }catch(e){}
}

// Label sizes with fixed barcode heights
const labelSizes={
  '38x25':{w:38,h:25,pxW:144,pxH:94,bh:22},
  '50x25':{w:50,h:25,pxW:189,pxH:94,bh:24},
  '50x30':{w:50,h:30,pxW:189,pxH:113,bh:28},
  '50x38':{w:50,h:38,pxW:189,pxH:144,bh:35},
  '60x40':{w:60,h:40,pxW:227,pxH:151,bh:40}
};

const products=[
  {id:1,name:'Organic Apples',sku:'SKU001',barcode:'8901234567001',price:250,category:'fruits'},
  {id:2,name:'Fresh Bananas',sku:'SKU002',barcode:'8901234567002',price:120,category:'fruits'},
  {id:3,name:'Sweet Oranges',sku:'SKU003',barcode:'8901234567003',price:180,category:'fruits'},
  {id:4,name:'Whole Milk 1L',sku:'SKU004',barcode:'8901234567004',price:85,category:'dairy'},
  {id:5,name:'Greek Yogurt',sku:'SKU005',barcode:'8901234567005',price:150,category:'dairy'},
  {id:6,name:'Cheddar Cheese',sku:'SKU006',barcode:'8901234567006',price:320,category:'dairy'},
  {id:7,name:'Sourdough Bread',sku:'SKU007',barcode:'8901234567007',price:95,category:'bakery'},
  {id:8,name:'Croissants Pack',sku:'SKU008',barcode:'8901234567008',price:180,category:'bakery'},
  {id:9,name:'Chicken Breast',sku:'SKU009',barcode:'8901234567009',price:450,category:'meat'},
  {id:10,name:'Ground Beef',sku:'SKU010',barcode:'8901234567010',price:380,category:'meat'},
  {id:11,name:'Fresh Carrots',sku:'SKU011',barcode:'8901234567011',price:60,category:'vegetables'},
  {id:12,name:'Broccoli',sku:'SKU012',barcode:'8901234567012',price:90,category:'vegetables'},
];

const purchaseData={'PUR-001':[1,2,3,4,5,6],'PUR-002':[7,8,9,10,11,12]};

function showToast(msg){const t=document.getElementById('toast');t.style.display='flex';document.getElementById('toastMsg').textContent=msg;setTimeout(()=>t.style.display='none',2000);}

function setPrinter(type){
  printerType=type;
  document.getElementById('prnRoll').className=type==='roll'?'flex-1 py-2 px-2 text-xs font-semibold rounded-lg bg-emerald-100 text-emerald-700 border-2 border-emerald-500':'flex-1 py-2 px-2 text-xs font-semibold rounded-lg bg-slate-100 text-slate-600 border-2 border-transparent';
  document.getElementById('prnA4').className=type==='a4'?'flex-1 py-2 px-2 text-xs font-semibold rounded-lg bg-emerald-100 text-emerald-700 border-2 border-emerald-500':'flex-1 py-2 px-2 text-xs font-semibold rounded-lg bg-slate-100 text-slate-600 border-2 border-transparent';
  saveSettings();
  renderPreview();
}

function setSource(src){
  ['search','purchase','category'].forEach(s=>{
    document.getElementById('src'+s.charAt(0).toUpperCase()+s.slice(1)).className=s===src?'flex-1 py-2 text-xs font-semibold rounded-lg bg-emerald-100 text-emerald-700 border-2 border-emerald-500':'flex-1 py-2 text-xs font-semibold rounded-lg bg-slate-100 text-slate-600 border-2 border-transparent';
    document.getElementById(s+'Panel').classList.toggle('hidden',s!==src);
  });
}

function searchProducts(){
  const q=document.getElementById('productSearch').value.toLowerCase();
  const res=document.getElementById('searchResults');
  if(!q){res.innerHTML='';return;}
  const list=products.filter(p=>p.name.toLowerCase().includes(q)||p.sku.toLowerCase().includes(q)||p.barcode.includes(q));
  res.innerHTML=list.map(p=>`
    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg hover:bg-emerald-50 cursor-pointer" onclick="addToQueue(${p.id})">
      <div><p class="text-sm font-medium text-slate-800">${p.name}</p><p class="text-[10px] text-slate-400">${p.sku}</p></div>
      <p class="text-sm font-bold text-emerald-600">‡ß≥${p.price}</p>
    </div>`).join('')||'<p class="text-center text-slate-400 text-sm py-4">No products found</p>';
}

function loadPurchaseItems(){
  const inv=document.getElementById('purchaseInvoice').value;
  const c=document.getElementById('purchaseItems');
  if(!inv){c.innerHTML='';return;}
  const items=(purchaseData[inv]||[]).map(id=>products.find(p=>p.id===id)).filter(Boolean);
  c.innerHTML=items.map(p=>`
    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
      <label class="flex items-center gap-2"><input type="checkbox" class="pur-chk w-4 h-4 rounded" data-id="${p.id}" checked><span class="text-sm">${p.name}</span></label>
    </div>`).join('')+`<button onclick="addPurchaseItems()" class="w-full mt-2 py-2 text-xs font-semibold bg-emerald-100 text-emerald-700 rounded-lg">Add Selected</button>`;
}

function addPurchaseItems(){document.querySelectorAll('.pur-chk:checked').forEach(cb=>addToQueue(+cb.dataset.id));}

function loadCategoryProducts(){
  const cat=document.getElementById('categorySelect').value;
  const c=document.getElementById('categoryProducts');
  if(!cat){c.innerHTML='';return;}
  const items=products.filter(p=>p.category===cat);
  c.innerHTML=items.map(p=>`
    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
      <label class="flex items-center gap-2"><input type="checkbox" class="cat-chk w-4 h-4 rounded" data-id="${p.id}"><span class="text-sm">${p.name}</span></label>
    </div>`).join('')+`<button onclick="addCategoryItems()" class="w-full mt-2 py-2 text-xs font-semibold bg-emerald-100 text-emerald-700 rounded-lg">Add Selected</button>`;
}

function addCategoryItems(){document.querySelectorAll('.cat-chk:checked').forEach(cb=>addToQueue(+cb.dataset.id));}

function addToQueue(id){
  const p=products.find(x=>x.id===id);if(!p)return;
  const ex=printQueue.find(q=>q.id===id);
  if(ex)ex.copies++;else printQueue.push({...p,copies:1});
  renderQueue();renderPreview();showToast('Added: '+p.name);
}

function updateCopies(id,val){
  const item=printQueue.find(q=>q.id===id);
  if(item)item.copies=Math.max(1,parseInt(val)||1);
  renderQueue();renderPreview();
}

function removeFromQueue(id){printQueue=printQueue.filter(q=>q.id!==id);renderQueue();renderPreview();}

function renderQueue(){
  const c=document.getElementById('printQueue'),e=document.getElementById('emptyQueue');
  document.getElementById('queueCount').textContent=printQueue.length;
  document.getElementById('totalLabels').textContent=printQueue.reduce((s,q)=>s+q.copies,0)+' labels';
  if(!printQueue.length){c.innerHTML='';e.style.display='block';return;}
  e.style.display='none';
  c.innerHTML=printQueue.map(q=>`
    <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg">
      <div class="flex-1 min-w-0"><p class="text-sm font-medium text-slate-800 truncate">${q.name}</p><p class="text-[10px] text-slate-400">${q.sku} ‚Ä¢ ‡ß≥${q.price}</p></div>
      <div class="flex items-center gap-1">
        <button onclick="updateCopies(${q.id},${q.copies-1})" class="w-6 h-6 rounded bg-slate-200 hover:bg-slate-300 text-sm">-</button>
        <input type="number" value="${q.copies}" min="1" onchange="updateCopies(${q.id},this.value)" class="w-10 text-center border rounded py-1 text-xs">
        <button onclick="updateCopies(${q.id},${q.copies+1})" class="w-6 h-6 rounded bg-slate-200 hover:bg-slate-300 text-sm">+</button>
      </div>
      <button onclick="removeFromQueue(${q.id})" class="p-1 text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
    </div>`).join('');
}

function changeFont(d){
  fontSize=Math.max(6,Math.min(14,fontSize+d));
  document.getElementById('fontSizeVal').textContent=fontSize;
  saveSettings();
  renderPreview();
}

function getSettings(){
  const sizeKey=document.getElementById('labelSize').value;
  const s=labelSizes[sizeKey]||labelSizes['38x25'];
  
  return{
    sizeKey,
    w:s.w,h:s.h,
    pxW:s.pxW,pxH:s.pxH,
    bh:s.bh,
    fs:fontSize,
    showShop:document.getElementById('showShop').checked,
    showName:document.getElementById('showName').checked,
    showPrice:document.getElementById('showPrice').checked,
    showVat:document.getElementById('showVat').checked,
    shop:document.getElementById('shopName').value
  };
}

function createLabel(q,s,uid,forPrint=false){
  const w=forPrint?s.w+'mm':s.pxW+'px';
  const h=forPrint?s.h+'mm':s.pxH+'px';
  const border=(forPrint && printerType==='roll')?'none':'1px solid #ccc';
  const vat=s.showVat?' +VAT++':'';
  const gap=Math.max(1,s.fs*0.28)+'px';
  
  return`<div class="bcode" style="width:${w};height:${h};padding:2px;border:${border};gap:${gap}">
    ${s.showShop?`<div class="shop-name" style="font-size:${s.fs}px">${s.shop}</div>`:''}
    <svg id="${uid}"></svg>
    ${s.showName?`<div class="product-name" style="font-size:${s.fs}px">${q.name.substring(0,26)}</div>`:''}
    ${s.showPrice?`<div class="price" style="font-size:${s.fs}px">‡ß≥${q.price}${vat}</div>`:''}
  </div>`;
}

function renderPreview(){
  const s=getSettings();
  const preview=document.getElementById('previewArea');
  document.getElementById('sizeInfo').textContent=`${s.w}√ó${s.h}mm | ${printerType==='roll'?'Roll':'A4'}`;
  saveSettings();
  
  if(!printQueue.length){
    preview.innerHTML='<p class="text-slate-400 text-sm p-8">Add products to see preview</p>';
    return;
  }
  
  let html='';let idx=0;
  printQueue.forEach(q=>{
    for(let i=0;i<q.copies;i++){
      html+=createLabel(q,s,'bc_'+q.id+'_'+idx,false);
      idx++;
    }
  });
  preview.innerHTML=html;
  document.getElementById('previewWrap').style.transform=`scale(${zoom/100})`;
  
  setTimeout(()=>{
    idx=0;
    printQueue.forEach(q=>{
      for(let i=0;i<q.copies;i++){
        try{JsBarcode('#bc_'+q.id+'_'+idx,q.barcode,{format:'CODE128',lineColor:'#000',height:s.bh,displayValue:true,fontSize:10,margin:0,width:0.9});}catch(e){}
        idx++;
      }
    });
  },30);
}

function zoomIn(){zoom=Math.min(200,zoom+20);document.getElementById('zoomLevel').textContent=zoom+'%';document.getElementById('previewWrap').style.transform=`scale(${zoom/100})`;saveSettings();}
function zoomOut(){zoom=Math.max(50,zoom-20);document.getElementById('zoomLevel').textContent=zoom+'%';document.getElementById('previewWrap').style.transform=`scale(${zoom/100})`;saveSettings();}
function clearAll(){printQueue=[];renderQueue();renderPreview();showToast('Cleared');}

function printLabels(){
  if(!printQueue.length){showToast('Add products first');return;}
  
  const s=getSettings();
  const printArea=document.getElementById('printArea');
  
  let html=`<div class="print-${printerType}" style="background:#fff;${printerType==='a4'?'display:flex;flex-wrap:wrap;gap:2mm;padding:5mm;':''}">`;
  let idx=0;
  printQueue.forEach(q=>{
    for(let i=0;i<q.copies;i++){
      html+=createLabel(q,s,'pbc_'+q.id+'_'+idx,true);
      idx++;
    }
  });
  html+='</div>';
  printArea.innerHTML=html;
  printArea.style.display='block';
  
  setTimeout(()=>{
    idx=0;
    printQueue.forEach(q=>{
      for(let i=0;i<q.copies;i++){
        try{JsBarcode('#pbc_'+q.id+'_'+idx,q.barcode,{format:'CODE128',lineColor:'#000',height:s.bh,displayValue:true,fontSize:10,margin:0,width:0.9});}catch(e){}
        idx++;
      }
    });
    setTimeout(()=>{window.print();setTimeout(()=>{printArea.style.display='none';},500);},100);
  },50);
}

loadSettings();
renderQueue();
renderPreview();
</script>
</body>
</html>
