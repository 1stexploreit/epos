<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>New Purchase - FreshMart POS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    *{font-family:'Inter',sans-serif;box-sizing:border-box;}
    body{background:#f8fafc;min-height:100vh;padding-bottom:90px;}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 1px 3px rgba(0,0,0,0.05);}
    .input-light{background:#f8fafc;border:1px solid #e2e8f0;color:#1e293b;border-radius:10px;}
    .input-light:focus{outline:none;border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,0.1);}
    .input-light::placeholder{color:#94a3b8;}
    .btn-primary{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;font-weight:600;}
    .btn-primary:hover{background:linear-gradient(135deg,#34d399 0%,#10b981 100%);}
    .modal{display:none;}.modal.active{display:flex;}
    .item-row{animation:fadeIn .25s ease;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    .emerald-glow{box-shadow:0 0 30px rgba(16,185,129,0.1);}
    ::-webkit-scrollbar{width:6px;height:6px;}
    ::-webkit-scrollbar-track{background:#f1f5f9;}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px;}
    .tag{font-size:10px;padding:4px 8px;border-radius:6px;font-weight:600;text-transform:uppercase;}
  </style>
</head>
<body class="text-slate-700">
  
  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
    <div class="max-w-[1400px] mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button onclick="window.history.back()" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          </button>
          <div>
            <div class="flex items-center gap-2">
              <span class="tag bg-emerald-100 text-emerald-700">Purchase Order</span>
              <span id="purchaseNum" class="text-xl font-bold text-slate-800">PUR-0001</span>
            </div>
            <p class="text-xs text-slate-400 mt-0.5">Create new purchase from supplier</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <select id="purchaseStatus" class="input-light px-3 py-2 text-sm">
            <option value="draft">üìù Draft</option>
            <option value="pending">üìã Pending</option>
            <option value="ordered">üì¶ Ordered</option>
            <option value="received">‚úÖ Received</option>
            <option value="cancelled">‚ùå Cancelled</option>
          </select>
          <button onclick="savePurchase('save')" class="btn-primary px-5 py-2.5 rounded-xl text-sm hidden md:flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            Save Purchase
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-[1400px] mx-auto p-4 md:p-6">
    
    <!-- Top Section: Supplier & Order Details Combined -->
    <div class="card p-5 mb-6">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <div class="w-11 h-11 rounded-xl bg-emerald-100 flex items-center justify-center">
          <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
        </div>
        <div>
          <h2 class="font-semibold text-slate-800">Supplier & Order Information</h2>
          <p class="text-xs text-slate-400">Select supplier and enter order details</p>
        </div>
        <button onclick="openSupplierModal()" class="ml-auto px-3 py-1.5 rounded-lg bg-emerald-100 text-emerald-700 text-xs font-semibold hover:bg-emerald-200 transition">+ NEW SUPPLIER</button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div class="relative md:col-span-2">
          <label class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 block">Supplier</label>
          <input type="text" id="supplierSearch" class="w-full input-light px-4 py-2.5 text-sm" placeholder="Search supplier..." oninput="searchSuppliers()" onfocus="showSupplierDropdown()">
          <svg class="w-4 h-4 text-slate-400 absolute right-3 bottom-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <div id="supplierDropdown" class="hidden absolute top-full left-0 right-0 mt-1 card shadow-xl z-30 max-h-48 overflow-y-auto"></div>
        </div>
        <div>
          <label class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 block">Order Date</label>
          <input type="date" id="purchaseDate" class="w-full input-light px-3 py-2.5 text-sm">
        </div>
        <div>
          <label class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 block">Due Date</label>
          <input type="date" id="purchaseDueDate" class="w-full input-light px-3 py-2.5 text-sm">
        </div>
        <div>
          <label class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 block">Supplier Inv.</label>
          <input type="text" id="supplierInvoice" class="w-full input-light px-3 py-2.5 text-sm" placeholder="INV-XXX">
        </div>
        <div>
          <label class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 block">Warehouse</label>
          <select id="warehouse" class="w-full input-light px-3 py-2.5 text-sm">
            <option value="main">Main</option>
            <option value="branch1">Branch 1</option>
          </select>
        </div>
      </div>
      <input type="hidden" id="selectedSupplierId" value="">
      <input type="hidden" id="suppName" value="">
      <input type="hidden" id="suppPhone" value="">
      <input type="hidden" id="suppAddress" value="">
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
      
      <!-- Products Section -->
      <div class="xl:col-span-9">
        
        <!-- Search Bar -->
        <div class="card p-4 mb-4 emerald-glow">
          <div class="flex flex-wrap gap-3">
            <div class="flex-1 min-w-[200px] relative">
              <input type="text" id="productSearch" class="w-full input-light px-4 py-3 pl-11 text-sm" placeholder="Search products by name or SKU..." oninput="searchProducts()" onfocus="showDropdown()">
              <svg class="w-5 h-5 text-emerald-500 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
              <div id="productDropdown" class="hidden absolute top-full left-0 right-0 mt-2 card shadow-xl z-20 max-h-80 overflow-y-auto"></div>
            </div>
            <select id="categoryFilter" onchange="onCategoryChange()" class="input-light px-4 py-3 text-sm">
              <option value="">All Categories</option>
              <option value="fruits">üçé Fruits</option>
              <option value="dairy">ü•õ Dairy</option>
              <option value="bakery">üçû Bakery</option>
              <option value="meat">ü•© Meat</option>
              <option value="vegetables">ü•ï Vegetables</option>
            </select>
            <select id="subCategoryFilter" onchange="searchProducts()" class="input-light px-4 py-3 text-sm hidden">
              <option value="">All</option>
            </select>
            <div class="flex">
              <input type="text" id="barcodeInput" class="w-36 input-light rounded-r-none px-4 py-3 text-sm border-r-0" placeholder="Barcode/SKU" onkeypress="if(event.key==='Enter')scanBarcode()">
              <button onclick="scanBarcode()" class="btn-primary px-4 rounded-l-none rounded-r-xl">‚èé</button>
            </div>
          </div>
        </div>

        <!-- Items Table -->
        <div class="card overflow-hidden">
          <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
              <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
              Purchase Items
              <span id="itemCount" class="tag bg-emerald-100 text-emerald-700 ml-1">0</span>
            </h3>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-slate-50">
                  <th class="text-left p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider w-12">#</th>
                  <th class="text-left p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Product</th>
                  <th class="text-center p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider w-28">Bulk Qty</th>
                  <th class="text-center p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider w-28">Unit Qty</th>
                  <th class="text-center p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider w-20">Total</th>
                  <th class="text-right p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider w-28">Cost</th>
                  <th class="text-right p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider w-28">Amount</th>
                  <th class="w-12"></th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>
          </div>
          
          <div id="emptyItems" class="p-12 text-center">
            <div class="w-20 h-20 rounded-2xl bg-slate-100 flex items-center justify-center mx-auto mb-4">
              <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            </div>
            <p class="text-slate-500 font-medium">No items added</p>
            <p class="text-slate-400 text-sm mt-1">Search products or scan barcode to add</p>
          </div>
        </div>

        <!-- Notes -->
        <div class="card p-5 mt-4">
          <label class="text-xs text-slate-500 uppercase tracking-wider mb-2 block">Internal Notes</label>
          <textarea id="internalNotes" rows="2" class="w-full input-light px-4 py-3 text-sm resize-none" placeholder="Add notes about this purchase order..."></textarea>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="xl:col-span-3 space-y-4">
        
        <!-- Summary -->
        <div class="card p-5">
          <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            Order Summary
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center text-sm">
              <span class="text-slate-500">Subtotal</span>
              <span id="subtotal" class="text-slate-800 font-medium">$0.00</span>
            </div>
            <div class="flex justify-between items-center text-sm">
              <span class="text-slate-500">Discount</span>
              <input type="number" id="orderDiscount" class="w-20 input-light px-2 py-1.5 text-sm text-right" value="0" oninput="calculate()">
            </div>
            <div class="flex justify-between items-center text-sm">
              <span class="text-slate-500">Tax (%)</span>
              <input type="number" id="taxPercent" class="w-20 input-light px-2 py-1.5 text-sm text-right" value="0" oninput="calculate()">
            </div>
            <div class="flex justify-between items-center text-sm">
              <span class="text-slate-500">Shipping</span>
              <input type="number" id="shippingCost" class="w-20 input-light px-2 py-1.5 text-sm text-right" value="0" oninput="calculate()">
            </div>
            <div class="flex justify-between items-center text-sm">
              <span class="text-slate-500">Other</span>
              <input type="number" id="otherCost" class="w-20 input-light px-2 py-1.5 text-sm text-right" value="0" oninput="calculate()">
            </div>
            <div class="border-t border-slate-100 pt-4 mt-4">
              <div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl p-4 text-center">
                <p class="text-emerald-100 text-xs font-medium mb-1">GRAND TOTAL</p>
                <p id="grandTotal" class="text-2xl font-extrabold text-white">$0.00</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment -->
        <div class="card p-5">
          <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Payment
          </h3>
          <div class="space-y-3">
            <div>
              <label class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 block">Amount Paid</label>
              <input type="number" step="0.01" id="paidAmount" class="w-full input-light px-4 py-3 text-lg font-bold text-center" placeholder="0.00" oninput="updateBalance()">
            </div>
            <div>
              <label class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 block">Method</label>
              <select id="payMethod" class="w-full input-light px-4 py-2.5 text-sm">
                <option value="bank">üè¶ Bank Transfer</option>
                <option value="cash">üíµ Cash</option>
                <option value="cheque">üìù Cheque</option>
              </select>
            </div>
            <div>
              <label class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 block">Reference</label>
              <input type="text" id="payRef" class="w-full input-light px-4 py-2.5 text-sm" placeholder="Transaction ID">
            </div>
            <div id="balanceBox" class="hidden p-3 rounded-xl bg-amber-50 border border-amber-200">
              <div class="flex justify-between items-center">
                <span class="text-amber-700 text-sm font-medium">Balance Due</span>
                <span id="balanceDue" class="text-lg font-bold text-amber-700">$0.00</span>
              </div>
            </div>
            <div id="overpaidBox" class="hidden p-3 rounded-xl bg-emerald-50 border border-emerald-200">
              <div class="flex justify-between items-center">
                <span class="text-emerald-700 text-sm font-medium">Overpaid</span>
                <span id="overpaidAmount" class="text-lg font-bold text-emerald-700">$0.00</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-40">
    <div class="max-w-[1400px] mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-6 text-sm">
        <span class="text-slate-500">Items: <strong id="footerItems" class="text-slate-800">0</strong></span>
        <span class="text-slate-500">Total: <strong id="footerTotal" class="text-emerald-600">$0.00</strong></span>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="window.history.back()" class="px-4 py-2.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm font-medium transition">Cancel</button>
        <button onclick="savePurchase('draft')" class="px-4 py-2.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm font-medium transition">Save Draft</button>
        <button onclick="savePurchase('save')" class="btn-primary px-6 py-2.5 rounded-xl text-sm flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          Save Purchase
        </button>
      </div>
    </div>
  </footer>

  <!-- Supplier Modal -->
  <div id="supplierModal" class="modal fixed inset-0 bg-black/40 backdrop-blur-sm items-center justify-center z-50 p-4">
    <div class="card p-6 w-full max-w-md">
      <h3 class="text-lg font-bold text-slate-800 mb-4">Add New Supplier</h3>
      <div class="space-y-3">
        <input type="text" id="newSuppName" class="w-full input-light px-4 py-3 text-sm" placeholder="Supplier Name *">
        <input type="text" id="newSuppPhone" class="w-full input-light px-4 py-3 text-sm" placeholder="Phone *">
        <input type="email" id="newSuppEmail" class="w-full input-light px-4 py-3 text-sm" placeholder="Email">
        <textarea id="newSuppAddress" rows="2" class="w-full input-light px-4 py-3 text-sm resize-none" placeholder="Address"></textarea>
      </div>
      <div class="flex gap-3 mt-5">
        <button onclick="closeSupplierModal()" class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 font-medium transition">Cancel</button>
        <button onclick="saveNewSupplier()" class="flex-1 py-3 btn-primary rounded-xl">Save Supplier</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal fixed inset-0 bg-black/40 backdrop-blur-sm items-center justify-center z-50 p-4">
    <div class="card p-6 w-full max-w-sm text-center">
      <div class="w-16 h-16 rounded-2xl bg-emerald-100 flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
      </div>
      <h3 class="text-xl font-bold text-slate-800 mb-1">Purchase Saved!</h3>
      <p id="successPurchase" class="text-lg font-bold text-emerald-600 mb-1">PUR-0001</p>
      <p id="successInfo" class="text-sm text-slate-500 mb-5">Total: $0.00</p>
      <div class="flex gap-3">
        <button onclick="newPurchase()" class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 font-medium transition">New Purchase</button>
        <button onclick="document.getElementById('successModal').classList.remove('active')" class="flex-1 py-3 btn-primary rounded-xl">Done</button>
      </div>
    </div>
  </div>

  <script>
    var products = [
      { id: 1, name: 'Organic Apples', sku: '1001', barcode: '8901234567890', unitCost: 3.50, pcsPerBulk: 12, bulkUnit: 'Carton', emoji: 'üçé', category: 'fruits', subCategory: 'fresh' },
      { id: 2, name: 'Fresh Bananas', sku: '1002', barcode: '8901234567891', unitCost: 1.80, pcsPerBulk: 12, bulkUnit: 'Box', emoji: 'üçå', category: 'fruits', subCategory: 'tropical' },
      { id: 3, name: 'Sweet Oranges', sku: '1003', barcode: '8901234567892', unitCost: 2.80, pcsPerBulk: 10, bulkUnit: 'Carton', emoji: 'üçä', category: 'fruits', subCategory: 'citrus' },
      { id: 4, name: 'Whole Milk 1L', sku: '2001', barcode: '8901234567893', unitCost: 2.50, pcsPerBulk: 12, bulkUnit: 'Case', emoji: 'ü•õ', category: 'dairy', subCategory: 'milk' },
      { id: 5, name: 'Greek Yogurt', sku: '2002', barcode: '8901234567894', unitCost: 4.00, pcsPerBulk: 10, bulkUnit: 'Pack', emoji: 'ü´ô', category: 'dairy', subCategory: 'yogurt' },
      { id: 6, name: 'Cheddar Cheese', sku: '2003', barcode: '8901234567895', unitCost: 5.50, pcsPerBulk: 10, bulkUnit: 'Box', emoji: 'üßÄ', category: 'dairy', subCategory: 'cheese' },
      { id: 7, name: 'Sourdough Bread', sku: '3001', barcode: '8901234567896', unitCost: 3.50, pcsPerBulk: 10, bulkUnit: 'Bundle', emoji: 'üçû', category: 'bakery', subCategory: 'bread' },
      { id: 8, name: 'Croissants', sku: '3002', barcode: '8901234567897', unitCost: 5.00, pcsPerBulk: 12, bulkUnit: 'Dozen', emoji: 'ü•ê', category: 'bakery', subCategory: 'pastry' },
      { id: 9, name: 'Chicken Breast', sku: '4001', barcode: '8901234567898', unitCost: 9.50, pcsPerBulk: 10, bulkUnit: 'Carton', emoji: 'üçó', category: 'meat', subCategory: 'poultry' },
      { id: 10, name: 'Ground Beef', sku: '4002', barcode: '8901234567899', unitCost: 7.50, pcsPerBulk: 10, bulkUnit: 'Box', emoji: 'ü•©', category: 'meat', subCategory: 'beef' },
      { id: 11, name: 'Fresh Carrots', sku: '5001', barcode: '8901234567900', unitCost: 2.00, pcsPerBulk: 10, bulkUnit: 'Bundle', emoji: 'ü•ï', category: 'vegetables', subCategory: 'root' },
      { id: 12, name: 'Broccoli', sku: '5002', barcode: '8901234567901', unitCost: 2.50, pcsPerBulk: 10, bulkUnit: 'Case', emoji: 'ü•¶', category: 'vegetables', subCategory: 'green' }
    ];

    var suppliers = [
      { id: '1', name: 'Fresh Farms Co.', code: 'S001', phone: '555-1111', address: '100 Farm Road' },
      { id: '2', name: 'Dairy Direct', code: 'S002', phone: '555-2222', address: '200 Milk Lane' },
      { id: '3', name: 'Meat Masters', code: 'S003', phone: '555-3333', address: '300 Butcher St' }
    ];

    var subCategories = {
      fruits: [{ value: 'fresh', label: 'Fresh' }, { value: 'tropical', label: 'Tropical' }, { value: 'citrus', label: 'Citrus' }],
      dairy: [{ value: 'milk', label: 'Milk' }, { value: 'cheese', label: 'Cheese' }, { value: 'yogurt', label: 'Yogurt' }],
      bakery: [{ value: 'bread', label: 'Bread' }, { value: 'pastry', label: 'Pastry' }],
      meat: [{ value: 'poultry', label: 'Poultry' }, { value: 'beef', label: 'Beef' }],
      vegetables: [{ value: 'green', label: 'Green' }, { value: 'root', label: 'Root' }]
    };

    var items = [];
    var purchaseNum = 1;

    var today = new Date();
    document.getElementById('purchaseDate').value = today.toISOString().split('T')[0];
    document.getElementById('purchaseDueDate').value = new Date(today.getTime() + 30*24*60*60*1000).toISOString().split('T')[0];

    function searchSuppliers() {
      var q = document.getElementById('supplierSearch').value.toLowerCase();
      var dd = document.getElementById('supplierDropdown');
      dd.classList.remove('hidden');
      var html = '<div onclick="selectSupplier(\'new\',\'\',\'\',\'\')" class="p-3 hover:bg-emerald-50 cursor-pointer border-b border-slate-100 text-emerald-600 font-medium">+ Add New Supplier</div>';
      for (var i = 0; i < suppliers.length; i++) {
        var s = suppliers[i];
        if (s.name.toLowerCase().indexOf(q) !== -1 || s.phone.indexOf(q) !== -1) {
          html += '<div onclick="selectSupplier(\'' + s.id + '\',\'' + s.name + '\',\'' + s.phone + '\',\'' + s.address + '\')" class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100"><p class="font-medium text-slate-800">' + s.name + '</p><p class="text-xs text-slate-400">' + s.phone + ' ‚Ä¢ ' + s.address + '</p></div>';
        }
      }
      dd.innerHTML = html;
    }

    function showSupplierDropdown() { searchSuppliers(); }

    function selectSupplier(id, name, phone, address) {
      document.getElementById('selectedSupplierId').value = id;
      document.getElementById('supplierSearch').value = name;
      document.getElementById('suppName').value = name;
      document.getElementById('suppPhone').value = phone;
      document.getElementById('suppAddress').value = address;
      document.getElementById('supplierDropdown').classList.add('hidden');
    }

    function openSupplierModal() { document.getElementById('supplierModal').classList.add('active'); }
    function closeSupplierModal() { document.getElementById('supplierModal').classList.remove('active'); }

    function saveNewSupplier() {
      var name = document.getElementById('newSuppName').value;
      var phone = document.getElementById('newSuppPhone').value;
      if (!name || !phone) { alert('Name and Phone required'); return; }
      var newCode = 'S' + String(suppliers.length + 1).padStart(3, '0');
      var addr = document.getElementById('newSuppAddress').value;
      suppliers.push({ id: String(suppliers.length + 1), name: name, code: newCode, phone: phone, address: addr });
      selectSupplier(String(suppliers.length), name, phone, addr);
      closeSupplierModal();
      document.getElementById('newSuppName').value = '';
      document.getElementById('newSuppPhone').value = '';
      document.getElementById('newSuppEmail').value = '';
      document.getElementById('newSuppAddress').value = '';
    }

    document.addEventListener('click', function(e) {
      if (!e.target.closest('#supplierSearch, #supplierDropdown')) document.getElementById('supplierDropdown').classList.add('hidden');
      if (!e.target.closest('#productSearch, #productDropdown, #categoryFilter, #subCategoryFilter')) document.getElementById('productDropdown').classList.add('hidden');
    });

    function scanBarcode() {
      var code = document.getElementById('barcodeInput').value.trim();
      if (!code) return;
      var p = null;
      for (var i = 0; i < products.length; i++) {
        if (products[i].barcode === code || products[i].sku === code) { p = products[i]; break; }
      }
      if (p) { addItem(p.id); document.getElementById('barcodeInput').value = ''; }
      else { alert('Product not found'); }
    }

    function onCategoryChange() {
      var cat = document.getElementById('categoryFilter').value;
      var subSel = document.getElementById('subCategoryFilter');
      if (cat && subCategories[cat]) {
        subSel.classList.remove('hidden');
        var opts = '<option value="">All</option>';
        for (var i = 0; i < subCategories[cat].length; i++) {
          opts += '<option value="' + subCategories[cat][i].value + '">' + subCategories[cat][i].label + '</option>';
        }
        subSel.innerHTML = opts;
      } else {
        subSel.classList.add('hidden');
        subSel.value = '';
      }
      searchProducts();
    }

    function searchProducts() {
      var q = document.getElementById('productSearch').value.toLowerCase();
      var cat = document.getElementById('categoryFilter').value;
      var subCat = document.getElementById('subCategoryFilter').value;
      var dd = document.getElementById('productDropdown');
      var filtered = [];
      for (var i = 0; i < products.length; i++) {
        var p = products[i];
        if (cat && p.category !== cat) continue;
        if (subCat && p.subCategory !== subCat) continue;
        if (q && p.name.toLowerCase().indexOf(q) === -1 && p.sku.indexOf(q) === -1) continue;
        filtered.push(p);
        if (filtered.length >= 8) break;
      }
      if (!q && !cat && !subCat) { dd.classList.add('hidden'); return; }
      dd.classList.remove('hidden');
      var html = '';
      if (filtered.length) {
        for (var i = 0; i < filtered.length; i++) {
          var p = filtered[i];
          html += '<div onclick="addItem(' + p.id + ')" class="flex items-center gap-3 p-4 hover:bg-emerald-50 cursor-pointer border-b border-slate-100 transition"><span class="text-2xl">' + p.emoji + '</span><div class="flex-1"><p class="font-medium text-slate-800">' + p.name + '</p><p class="text-xs text-slate-400">' + p.sku + ' ‚Ä¢ ' + p.bulkUnit + ': ' + p.pcsPerBulk + ' pcs</p></div><div class="text-right"><p class="font-bold text-emerald-600">$' + p.unitCost.toFixed(2) + '</p></div></div>';
        }
      } else {
        html = '<p class="p-4 text-center text-slate-400">No products found</p>';
      }
      dd.innerHTML = html;
    }

    function showDropdown() { if (document.getElementById('productSearch').value || document.getElementById('categoryFilter').value) searchProducts(); }

    function addItem(id) {
      var p = null;
      for (var i = 0; i < products.length; i++) {
        if (products[i].id === id) { p = products[i]; break; }
      }
      if (!p) return;
      var existing = null;
      for (var i = 0; i < items.length; i++) {
        if (items[i].id === id) { existing = items[i]; break; }
      }
      if (existing) {
        existing.unitQty++;
      } else {
        items.push({
          id: p.id, name: p.name, sku: p.sku, emoji: p.emoji,
          pcsPerBulk: p.pcsPerBulk, bulkUnit: p.bulkUnit, unitCost: p.unitCost,
          bulkQty: 0, unitQty: 1, cost: p.unitCost
        });
      }
      document.getElementById('productSearch').value = '';
      document.getElementById('productDropdown').classList.add('hidden');
      renderItems();
    }

    function renderItems() {
      var tbody = document.getElementById('itemsBody');
      var empty = document.getElementById('emptyItems');
      document.getElementById('itemCount').textContent = items.length;
      document.getElementById('footerItems').textContent = items.length;
      if (!items.length) {
        tbody.innerHTML = '';
        empty.classList.remove('hidden');
        calculate();
        return;
      }
      empty.classList.add('hidden');
      var html = '';
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var totalQty = (item.bulkQty * item.pcsPerBulk) + item.unitQty;
        var cost = item.cost || item.unitCost;
        var total = cost * totalQty;
        html += '<tr class="item-row border-b border-slate-100 hover:bg-slate-50 transition">';
        html += '<td class="p-4 text-slate-400">' + (i + 1) + '</td>';
        html += '<td class="p-4"><div class="flex items-center gap-3"><span class="text-2xl">' + item.emoji + '</span><div><p class="font-medium text-slate-800">' + item.name + '</p><p class="text-xs text-slate-400">' + item.sku + ' ‚Ä¢ ' + item.bulkUnit + ': ' + item.pcsPerBulk + '</p></div></div></td>';
        html += '<td class="p-3"><div class="flex items-center justify-center gap-1"><button onclick="changeBulk(' + i + ',-1)" class="w-8 h-8 rounded-lg bg-slate-100 hover:bg-emerald-100 text-slate-500 hover:text-emerald-600 transition">-</button><input type="number" value="' + item.bulkQty + '" min="0" onchange="setBulk(' + i + ',this.value)" class="w-14 text-center input-light py-1.5 text-sm"><button onclick="changeBulk(' + i + ',1)" class="w-8 h-8 rounded-lg bg-slate-100 hover:bg-emerald-100 text-slate-500 hover:text-emerald-600 transition">+</button></div></td>';
        html += '<td class="p-3"><div class="flex items-center justify-center gap-1"><button onclick="changeUnit(' + i + ',-1)" class="w-8 h-8 rounded-lg bg-slate-100 hover:bg-emerald-100 text-slate-500 hover:text-emerald-600 transition">-</button><input type="number" value="' + item.unitQty + '" min="0" onchange="setUnit(' + i + ',this.value)" class="w-14 text-center input-light py-1.5 text-sm"><button onclick="changeUnit(' + i + ',1)" class="w-8 h-8 rounded-lg bg-slate-100 hover:bg-emerald-100 text-slate-500 hover:text-emerald-600 transition">+</button></div></td>';
        html += '<td class="p-4 text-center"><span class="tag bg-blue-100 text-blue-700">' + totalQty + '</span></td>';
        html += '<td class="p-3 text-right"><input type="number" step="0.01" value="' + cost.toFixed(2) + '" onchange="setCost(' + i + ',this.value)" class="w-24 input-light py-1.5 px-3 text-sm text-right"></td>';
        html += '<td class="p-4 text-right font-bold text-emerald-600">$' + total.toFixed(2) + '</td>';
        html += '<td class="p-3"><button onclick="removeItem(' + i + ')" class="w-8 h-8 rounded-lg hover:bg-red-100 text-slate-400 hover:text-red-500 flex items-center justify-center transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>';
        html += '</tr>';
      }
      tbody.innerHTML = html;
      calculate();
    }

    function changeBulk(i, d) { items[i].bulkQty = Math.max(0, items[i].bulkQty + d); renderItems(); }
    function setBulk(i, v) { items[i].bulkQty = Math.max(0, parseInt(v) || 0); renderItems(); }
    function changeUnit(i, d) { items[i].unitQty = Math.max(0, items[i].unitQty + d); renderItems(); }
    function setUnit(i, v) { items[i].unitQty = Math.max(0, parseInt(v) || 0); renderItems(); }
    function setCost(i, v) { items[i].cost = Math.max(0, parseFloat(v) || 0); renderItems(); }
    function removeItem(i) { items.splice(i, 1); renderItems(); }

    function calculate() {
      var subtotal = 0;
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var totalQty = (item.bulkQty * item.pcsPerBulk) + item.unitQty;
        var cost = item.cost || item.unitCost;
        subtotal += cost * totalQty;
      }
      var discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
      var net = Math.max(0, subtotal - discount);
      var tax = net * (parseFloat(document.getElementById('taxPercent').value) || 0) / 100;
      var shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
      var other = parseFloat(document.getElementById('otherCost').value) || 0;
      var grand = net + tax + shipping + other;
      document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('grandTotal').textContent = '$' + grand.toFixed(2);
      document.getElementById('footerTotal').textContent = '$' + grand.toFixed(2);
      updateBalance();
    }

    function updateBalance() {
      var total = parseFloat(document.getElementById('grandTotal').textContent.replace('$', '')) || 0;
      var paid = parseFloat(document.getElementById('paidAmount').value) || 0;
      document.getElementById('balanceBox').classList.add('hidden');
      document.getElementById('overpaidBox').classList.add('hidden');
      if (paid > 0 && paid < total) {
        document.getElementById('balanceBox').classList.remove('hidden');
        document.getElementById('balanceDue').textContent = '$' + (total - paid).toFixed(2);
      } else if (paid > total) {
        document.getElementById('overpaidBox').classList.remove('hidden');
        document.getElementById('overpaidAmount').textContent = '$' + (paid - total).toFixed(2);
      }
    }

    function savePurchase(action) {
      if (!items.length) { alert('Add items'); return; }
      if (!document.getElementById('selectedSupplierId').value && !document.getElementById('supplierSearch').value) { alert('Select supplier'); return; }
      document.getElementById('successPurchase').textContent = document.getElementById('purchaseNum').textContent;
      document.getElementById('successInfo').textContent = 'Total: ' + document.getElementById('grandTotal').textContent;
      document.getElementById('successModal').classList.add('active');
    }

    function newPurchase() {
      document.getElementById('successModal').classList.remove('active');
      purchaseNum++;
      document.getElementById('purchaseNum').textContent = 'PUR-' + String(purchaseNum).padStart(4, '0');
      items = [];
      document.getElementById('selectedSupplierId').value = '';
      document.getElementById('supplierSearch').value = '';
      document.getElementById('suppName').value = '';
      document.getElementById('suppPhone').value = '';
      document.getElementById('suppAddress').value = '';
      document.getElementById('payRef').value = '';
      document.getElementById('supplierInvoice').value = '';
      document.getElementById('internalNotes').value = '';
      document.getElementById('orderDiscount').value = 0;
      document.getElementById('taxPercent').value = 0;
      document.getElementById('shippingCost').value = 0;
      document.getElementById('otherCost').value = 0;
      document.getElementById('paidAmount').value = '';
      document.getElementById('balanceBox').classList.add('hidden');
      document.getElementById('overpaidBox').classList.add('hidden');
      document.getElementById('purchaseStatus').value = 'draft';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('subCategoryFilter').classList.add('hidden');
      renderItems();
    }

    renderItems();
  </script>
</body>
</html>